#---RelativePath.test--------------------- Executable---------------------#
#BEGIN_COMMENT
# This test checks the working of relative-path MapDetail option.
#END_COMMENT
#START_TEST

RUN: %rm -rf %t.tmpdir
RUN: %mkdir -p %t.tmpdir

RUN: %clang %clangopts -o %t.tmpdir/1.o %p/Inputs/1.c -c
RUN: %clang %clangopts -o %t.tmpdir/2.o %p/Inputs/2.c -c
RUN: %ar cr %t.tmpdir/lib2.a %t.tmpdir/2.o

RUN: %link -MapStyle txt %linkopts -o %t.tmpdir/out %t.tmpdir/1.o %t.tmpdir/lib2.a -MapDetail relative-path=%t.tmpdir -Map %t.tmpdir/map.txt --verbose 2>&1 | %filecheck %s --check-prefix=VERBOSE
RUN: %filecheck %s < %t.tmpdir/map.txt

RUN: %link -MapStyle txt %linkopts -o %t.tmpdir/out %t.tmpdir/1.o %t.tmpdir/lib2.a -MapDetail relative-path=. -Map %t.tmpdir/map.txt.dot
RUN: %filecheck %s --check-prefix=DOT < %t.tmpdir/map.txt.dot

RUN: %link -MapStyle txt %linkopts -o %t.tmpdir/out %t.tmpdir/1.o %t.tmpdir/lib2.a -MapDetail relative-path -Map %t.tmpdir/map.txt.default
RUN: %filecheck %s --check-prefix=DEFAULT < %t.tmpdir/map.txt.default

RUN: %rm -f %t.tmpdir/lib2.a
RUN: %ar --thin cr %t.tmpdir/lib2.a %t.tmpdir/2.o
RUN: %link -MapStyle txt %linkopts -o %t.tmpdir/out %t.tmpdir/1.o %t.tmpdir/lib2.a -MapDetail relative-path=%t.tmpdir -Map %t.tmpdir/map.txt --verbose 2>&1 | %filecheck %s --check-prefix=VERBOSE
RUN: %filecheck %s --check-prefix=CHECK_THIN < %t.tmpdir/map.txt
RUN: %link -MapStyle txt %linkopts -o %t.tmpdir/out %t.tmpdir/1.o %t.tmpdir/lib2.a -MapDetail relative-path=. -Map %t.tmpdir/map.txt.dot
RUN: %filecheck %s --check-prefix=DOT_THIN < %t.tmpdir/map.txt.dot
RUN: %link -MapStyle txt %linkopts -o %t.tmpdir/out %t.tmpdir/1.o %t.tmpdir/lib2.a -MapDetail relative-path -Map %t.tmpdir/map.txt.default
RUN: %filecheck %s --check-prefix=DEFAULT_THIN < %t.tmpdir/map.txt.default
#END_TEST
VERBOSE: Verbose: Using '{{.*}}' for computing relative paths in map files
CHECK: # Basepath: {{.*}}
CHECK: {{0x[0-9a-z]+}} 1.o
CHECK: {{0x[0-9a-z]+}} lib2.a(2.o)
CHECK: {{0x[0-9a-z]+}} Linker Version
CHECK-NOT: /1.o

DOT: # Basepath: {{.*}}
DOT: {{0x[0-9a-z]+}} {{[ -\(\)_A-Za-z0-9.\\/:]+}}1.o
DOT: {{0x[0-9a-z]+}} {{[ -\(\)_A-Za-z0-9.\\/:]+}}lib2.a(2.o)
DOT: {{0x[0-9a-z]+}} Linker Version

DEFAULT: # Basepath: {{.*}}
DEFAULT: {{0x[0-9a-z]+}} {{[ -\(\)_A-Za-z0-9.\\/:]+}}1.o
DEFAULT: {{0x[0-9a-z]+}} {{[ -\(\)_A-Za-z0-9.\\/:]+}}lib2.a(2.o)
DEFAULT: {{0x[0-9a-z]+}} Linker Version

CHECK_THIN: # Basepath: {{.*}}
CHECK_THIN: {{0x[0-9a-z]+}} 1.o
CHECK_THIN: {{0x[0-9a-z]+}} lib2.a(2.o)
CHECK_THIN: {{0x[0-9a-z]+}} Linker Version
CHECK_THIN-NOT: /1.o

DOT_THIN: # Basepath: {{.*}}
DOT_THIN: {{0x[0-9a-z]+}} {{[ -\(\)_A-Za-z0-9.\\/:]+}}1.o
DOT_THIN: {{0x[0-9a-z]+}} {{[ -\(\)_A-Za-z0-9.\\/:]+}}lib2.a({{.*}}2.o)
DOT_THIN: {{0x[0-9a-z]+}} Linker Version

DEFAULT_THIN: # Basepath: {{.*}}
DEFAULT_THIN: {{0x[0-9a-z]+}} {{[ -\(\)_A-Za-z0-9.\\/:]+}}1.o
DEFAULT_THIN: {{0x[0-9a-z]+}} {{[ -\(\)_A-Za-z0-9.\\/:]+}}lib2.a({{.*}}2.o)
DEFAULT_THIN: {{0x[0-9a-z]+}} Linker Version
