<!DOCTYPE html>
<html>
<head>
<title>Build Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="Footer" content="DeepDash by Deepmap">
<style>
  @media (prefers-color-scheme: dark) {
    body {
      background-color: #0D1117;
      color: white;
    }
  }
  .status {
    width: 25px;
    height: 25px;
    border-radius: 50%; /* circular */
    display: inline-block;
    margin-right: 5px;
  }

  .status-pass {
    background-color: green;
  }

  .status-fail {
    background-color: red;
  }

  .status-building {
    background-color: orange;
  }

  .flex-parent {
    display: flex;
  }

  .flex-child {
    flex: 1;
  }

  .footer {
    position: absolute;
    bottom: 0;
    right: 0;
  }

</style>

<link href="https://code.jquery.com/ui/1.13.3/themes/smoothness/jquery-ui.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/jquery-ui-daterangepicker@1.0.3-yrd/jquery.comiseo.daterangepicker.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-ui-daterangepicker@1.0.3-yrd/jquery.comiseo.daterangepicker.min.js"></script>
<script>
  $(function() { $("#datePicker").daterangepicker();});
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
  <h1>Build Status</h1>
  <br>
  <input id="datePicker" name="datePicker">
  <br><br>
  <div class="all-builds flex-parent">
    <div class="Build1 flex-child" style="max-width:400px;border:2px solid skyblue;border-style:inset hidden hidden inset;border-radius: 18px;">
      <canvas id="picoPie"></canvas><br>
      &nbsp;&nbsp;&nbsp;&nbsp;Picolibc Status <sub><span id="pico_green" class="status status-pass"></span><span id="pico_red" class="status status-fail"></span></sub>
    </div>
    <div class="Build2 flex-child" style="max-width: 400px;border:2px solid skyblue;border-style:inset hidden hidden inset;border-radius: 18px; display: none;">
      <canvas id="muslPie"></canvas>
      <br>
      &nbsp;&nbsp;&nbsp;&nbsp;MUSL Status <sub><span class="status status-fail"></span></sub>
    </div>
    <div class="Build3 flex-child" style="max-width: 400px;border:2px solid skyblue;border-style:inset hidden hidden inset;border-radius: 18px; display: none;">
      <canvas id="zephyrPie"></canvas>
      <br>
      &nbsp;&nbsp;&nbsp;&nbsp;Zephyr Status <sub><span class="status status-building"></span></sub>
    </div>
  </div>

  <script type="text/javascript" src="picolibc_status_data.py"></script>
  <script type="text/javascript" src="musl_status_data.py"></script>
  <script type="text/javascript" src="zephyr_status_data.py"></script>

  <script>
  const pico = document.getElementById("picoPie");
  const lastItem = picolibc_build_states[picolibc_build_states.length - 1];
  if (lastItem) {
      if(lastItem.state == 'pass') {
        $("#pico_green").show();
        $("#pico_red").hide();
      }
      else if(lastItem.state == 'fail') {
        $("#pico_green").hide();
        $("#pico_red").show();
      }
  } else {
    $("#pico_green").hide();
    $("#pico_red").hide();
  }
  let pico_passes = 0;
  let pico_fails = 0;
  picolibc_build_states.forEach(function(value, key) {
    if(value.state == 'pass')
      pico_passes += 1;
    else if (value.state == 'fail')
      pico_fails += 1;
  });
  const pico_pie = new Chart(pico, {
    type: 'pie',
    data: {
      labels: ['Pass', 'Fail'],
      datasets: [{
        label: '#Builds',
        data: [pico_passes, pico_fails],
        borderWidth: 2,
        backgroundColor: [
        'lightgreen',
        'red'
      ],
    hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'Picolibc Builds'
      },
        onClick: (e) => {
            window.open("picoBuilds.html", "_blank");
        }
    }
  });
  </script>

  <script>
  const musl = document.getElementById("muslPie");
  let musl_passes = 0;
  let musl_fails = 0;
  musl_build_states.forEach(function(value, key) {
    if(value.state == 'pass')
      musl_passes += 1;
    else if (value.state == 'fail')
      musl_fails += 1;
  });
  new Chart(musl, {
    type: 'pie',
    data: {
      labels: ['Pass', 'Fail'],
      datasets: [{
        label: '#Builds',
        data: [musl_passes, musl_fails],
        borderWidth: 2,
        backgroundColor: [
        'lightgreen',
        'red'
      ],
      }]
    }
  });
  </script>

  <script>
  const zephyr = document.getElementById("zephyrPie");
  let zephyr_passes = 0;
  let zephyr_fails = 0;
  let zephyr_building = 0;
  zephyr_build_states.forEach(function(value, key) {
    if(value.state == 'pass')
      zephyr_passes += 1;
    else if (value.state == 'fail')
      zephyr_fails += 1;
  });
  new Chart(zephyr, {
    type: 'pie',
    data: {
      labels: ['Pass', 'Fail', 'Building'],
      datasets: [{
        label: '#Builds',
        data: [zephyr_passes, zephyr_fails, zephyr_building],
        borderWidth: 2,
        backgroundColor: [
        'lightgreen',
        'red',
        'orange'
      ],
      }]
    }
  });
  </script>

  <script type="text/javascript">
    function filterPicoPie(start_date, end_date) {
      let updated_pico_passes = 0;
      let updated_pico_fails = 0;
      picolibc_build_states.forEach(function(value, key) {
        const range_start = new Date(start_date);
        const range_end = new Date(end_date);
        const build_date = new Date(value.date)
        if (build_date >= range_start && build_date <= range_end) {
          if(value.state == 'pass')
            updated_pico_passes += 1;
          else if (value.state == 'fail')
            updated_pico_fails += 1;
        }
      });
      console.log("Updating Pico Pie");
      pico_pie.data.datasets[0].data = [updated_pico_passes, updated_pico_fails];
      pico_pie.update();
    }

  $("#datePicker").on('change', function(event) {
    var range = $("#datePicker").val();
    if (range.length) {
      const date_range = JSON.parse(range);
      let start_date = date_range.start;
      let end_date = date_range.end;
      filterPicoPie(start_date, end_date);
    }
  });
  </script>

  <footer class="footer">
    DeepDash - Builds <sub>~DeepMap</sub>
  </footer>
</body>
</html>